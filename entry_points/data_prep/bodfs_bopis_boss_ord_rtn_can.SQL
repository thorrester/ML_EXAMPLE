CREATE OR REPLACE TABLE `{staging_project}.{staging_dataset}.BODFS_BOPIS_BOSS_ORD_RTN_CAN`
PARTITION BY CAL_DT
--CLUSTER BY SKU_NBR, STR_NBR
AS(
SELECT
CAL. CAL_DT
, CAL.FSCL_WK. FSCL_WK_END_DT
, CONCAT(CAST(COM.EXTN_SKU_CODE AS STRING),'-', CAST(COM. SKU_CRT_DT AS STRING), '-', COM.SHIP_NODE) AS SKU_STR_ID
, ROUND(COUNT(CASE WHEN UPPER(COM. EXTN_ORDERLINE_TYPE) = 'BOSS'  AND CD. D_EVENT_TRK_CD IN ('RETURNED','RETURN','RETURNED T') THEN COM. ORDER_LINE_KEY END),2) as BOSS_RTN_CNT
, ROUND(COUNT(CASE WHEN UPPER(COM. EXTN_ORDERLINE_TYPE) = 'BOPIS_WEB' AND CD. D_EVENT_TRK_CD IN ('RETURNED','RETURN','RETURNED T') THEN COM. ORDER_LINE_KEY END),2) as BOPIS_RTN_CNT
, ROUND(COUNT(CASE WHEN UPPER(COM. EXTN_ORDERLINE_TYPE) = 'BODFS_PROD' AND CD. D_EVENT_TRK_CD IN ('RETURNED','RETURN','RETURNED T') THEN COM. ORDER_LINE_KEY END),2) as BODFS_RTN_CNT
, ROUND(COUNT(CASE WHEN UPPER(COM. EXTN_ORDERLINE_TYPE) = 'BOSS' AND EVENT. EVENT_RSN_CODE IS NOT NULL AND EVENT. EVENT_RSN_CODE <> '0' AND EVENT. EVENT_TRK_CODE = 'C' THEN COM. ORDER_LINE_KEY END),2) as BOSS_CAN_CNT
, ROUND(COUNT(CASE WHEN UPPER(COM. EXTN_ORDERLINE_TYPE) = 'BOPIS_WEB' AND EVENT. EVENT_RSN_CODE IS NOT NULL AND EVENT. EVENT_RSN_CODE <> '0' AND EVENT. EVENT_TRK_CODE = 'C' THEN COM. ORDER_LINE_KEY END),2) as BOPIS_CAN_CNT
, ROUND(COUNT(CASE WHEN UPPER(COM. EXTN_ORDERLINE_TYPE) = 'BODFS_PROD' AND EVENT. EVENT_RSN_CODE IS NOT NULL AND EVENT. EVENT_RSN_CODE <> '0' AND EVENT. EVENT_TRK_CODE = 'C' THEN COM. ORDER_LINE_KEY END),2) as BODFS_CAN_CNT
, ROUND(COUNT(CASE WHEN UPPER(com.extn_orderline_type) = 'BOSS' THEN com.order_line_key END),2) as BOSS_ORD_CNT
, ROUND(COUNT(CASE WHEN UPPER(com.extn_orderline_type) = 'BOPIS_WEB' THEN com.order_line_key END),2) as BOPIS_ORD_CNT
, ROUND(COUNT(CASE WHEN UPPER(com.extn_orderline_type) = 'BODFS_PROD' THEN com.order_line_key END),2) as BODFS_ORD_CNT
FROM `{edw_project}.{edw_dataset_ord_com}.COM_LINE` as COM
LEFT JOIN `{edw_project}.{edw_dataset_ord_com}.COM_EVENT` as EVENT
    ON com.order_line_key = event.order_line_key
LEFT JOIN `{edw_project}.{edw_dataset_ord_com}.COM_EVENT_TRK_CD` as CD
    ON event.event_trk_code = cd.event_trk_code
INNER JOIN `{edw_project}.{edw_dataset_shared}.STR_HIER` as STR
    ON com.ship_node = str.str_nbr
INNER JOIN `{edw_project}.{edw_dataset_shared}.CAL_PRD_HIER` as CAL
    ON CAST(event.event_ts as DATE) = cal.cal_dt
LEFT JOIN `{edw_project}.{edw_dataset_shared}.SKU_HIER` as SKU
    ON com.extn_sku_code = sku.sku_nbr
    AND com.sku_crt_dt = sku.sku_crt_dt
WHERE UPPER(com.extn_orderline_type) IN ('BOSS','BOPIS_WEB','BODFS_PROD')
AND CAL_DT >= DATE_SUB(CURRENT_DATE, INTERVAL 104 WEEK)
GROUP BY
      CAL_DT
    , FSCL_WK_END_DT
    , COM. SHIP_NODE
    , EXTN_SKU_CODE
    , COM. SKU_CRT_DT
);
