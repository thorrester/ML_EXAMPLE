CREATE OR REPLACE TABLE `{staging_project}.{staging_dataset}.PACKDOWN_MODEL_DATA_STAGE04`
PARTITION BY CAL_DT
OPTIONS(expiration_timestamp=TIMESTAMP(DATE_ADD(CURRENT_DATE, INTERVAL 1 DAY)))
AS(
SELECT
A. CAL_DT
, C. SKU_NBR
, C. SKU_CRT_DT
, C. STR_NBR
, A. SKU_STR_ID
, E. FUFILLMNT_PATH
, CASE WHEN PREV_1_DAY_OH >= SAFE_MULTIPLY(D. OH_QTY,.05) THEN 1 ELSE 0 END OH_GRTR_FIVE_PERC_CLSS
, CASE WHEN A. PREV_1_DAY_OH < 0 AND A. PREV_2_DAY_OH < 0 AND A. PREV_1_DAY_UNTS >0 THEN 1 ELSE 0 END NEG_OH_POS_SLS_FLG
, SUM(CASE WHEN B. CAL_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 1 WEEK) AND  A. CAL_DT THEN  BOPIS_RTN_CNT ELSE 0 END)  WK_BOPIS_RTN_CNT
, SUM(CASE WHEN B. CAL_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 4 WEEK) AND  A. CAL_DT THEN  BOPIS_RTN_CNT ELSE 0 END) MTH_BOPIS_RTN_CNT
, SUM(CASE WHEN B. CAL_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 52 WEEK) AND A. CAL_DT THEN BOPIS_RTN_CNT ELSE 0 END)  YR_BOPIS_RTN_CNT
, SUM(CASE WHEN B. CAL_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 1 WEEK) AND  A. CAL_DT THEN  BOPIS_CAN_CNT ELSE 0 END)  WK_BOPIS_CAN_CNT
, SUM(CASE WHEN B. CAL_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 4 WEEK) AND  A. CAL_DT THEN  BOPIS_CAN_CNT ELSE 0 END) MTH_BOPIS_CAN_CNT
, SUM(CASE WHEN B. CAL_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 52 WEEK) AND A. CAL_DT THEN BOPIS_CAN_CNT ELSE 0 END)  YR_BOPIS_CAN_CNT
, SUM(CASE WHEN B. CAL_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 1 WEEK) AND  A. CAL_DT THEN  BOPIS_ORD_CNT ELSE 0 END)  WK_BOPIS_ORD_CNT
, SUM(CASE WHEN B. CAL_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 4 WEEK) AND  A. CAL_DT THEN  BOPIS_ORD_CNT ELSE 0 END) MTH_BOPIS_ORD_CNT
, SUM(CASE WHEN B. CAL_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 52 WEEK) AND A. CAL_DT THEN BOPIS_ORD_CNT ELSE 0 END)  YR_BOPIS_ORD_CNT
, SUM(CASE WHEN B. CAL_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 1 WEEK) AND  A. CAL_DT THEN  BODFS_RTN_CNT ELSE 0 END)  WK_BODFS_RTN_CNT
, SUM(CASE WHEN B. CAL_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 4 WEEK) AND  A. CAL_DT THEN  BODFS_RTN_CNT ELSE 0 END) MTH_BODFS_RTN_CNT
, SUM(CASE WHEN B. CAL_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 52 WEEK) AND A. CAL_DT THEN BODFS_RTN_CNT ELSE 0 END)  YR_BODFS_RTN_CNT
, SUM(CASE WHEN B. CAL_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 1 WEEK) AND  A. CAL_DT THEN  BODFS_CAN_CNT ELSE 0 END)  WK_BODFS_CAN_CNT
, SUM(CASE WHEN B. CAL_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 4 WEEK) AND  A. CAL_DT THEN  BODFS_CAN_CNT ELSE 0 END) MTH_BODFS_CAN_CNT
, SUM(CASE WHEN B. CAL_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 52 WEEK) AND A. CAL_DT THEN BODFS_CAN_CNT ELSE 0 END)  YR_BODFS_CAN_CNT
, SUM(CASE WHEN B. CAL_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 1 WEEK) AND  A. CAL_DT THEN  BODFS_ORD_CNT ELSE 0 END)  WK_BODFS_ORD_CNT
, SUM(CASE WHEN B. CAL_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 4 WEEK) AND  A. CAL_DT THEN  BODFS_ORD_CNT ELSE 0 END) MTH_BODFS_ORD_CNT
, SUM(CASE WHEN B. CAL_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 52 WEEK) AND A. CAL_DT THEN BODFS_ORD_CNT ELSE 0 END)  YR_BODFS_ORD_CNT
, SUM(CASE WHEN B. CAL_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 1 WEEK) AND  A. CAL_DT THEN  BOSS_RTN_CNT ELSE 0 END)  WK_BOSS_RTN_CNT
, SUM(CASE WHEN B. CAL_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 4 WEEK) AND  A. CAL_DT THEN  BOSS_RTN_CNT ELSE 0 END) MTH_BOSS_RTN_CNT
, SUM(CASE WHEN B. CAL_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 52 WEEK) AND A. CAL_DT THEN BOSS_RTN_CNT ELSE 0 END)  YR_BOSS_RTN_CNT
, SUM(CASE WHEN B. CAL_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 1 WEEK) AND  A. CAL_DT THEN  BOSS_CAN_CNT ELSE 0 END)  WK_BOSS_CAN_CNT
, SUM(CASE WHEN B. CAL_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 4 WEEK) AND  A. CAL_DT THEN  BOSS_CAN_CNT ELSE 0 END) MTH_BOSS_CAN_CNT
, SUM(CASE WHEN B. CAL_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 52 WEEK) AND A. CAL_DT THEN BOSS_CAN_CNT ELSE 0 END)  YR_BOSS_CAN_CNT
, SUM(CASE WHEN B. CAL_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 1 WEEK) AND  A. CAL_DT THEN  BOSS_ORD_CNT ELSE 0 END)  WK_BOSS_ORD_CNT
, SUM(CASE WHEN B. CAL_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 4 WEEK) AND  A. CAL_DT THEN  BOSS_ORD_CNT ELSE 0 END) MTH_BOSS_ORD_CNT
, SUM(CASE WHEN B. CAL_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 52 WEEK) AND A. CAL_DT THEN BOSS_ORD_CNT ELSE 0 END)  YR_BOSS_ORD_CNT
FROM `{staging_project}.{staging_dataset}.PACKDOWN_MODEL_DATA_STAGE01`  A
LEFT JOIN `{staging_project}.{staging_dataset}.BODFS_BOPIS_BOSS_ORD_RTN_CAN` B
    ON B. CAL_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 52 WEEK) AND A. CAL_DT
    AND A. SKU_STR_ID = B. SKU_STR_ID

INNER JOIN `{staging_project}.{staging_dataset}.THD_SKU_ACTIVE` C
  ON A. SKU_STR_ID = C. SKU_STR_ID

LEFT JOIN `{staging_project}.{staging_dataset}.CLASS_OH_DLY` D
    ON A. CAL_DT = D. CAL_DT
    AND C. EXT_CLASS_NBR = D. EXT_CLASS_NBR

LEFT JOIN (
        SELECT
        SKU_STR_ID
        , ARRAY_AGG(STRUCT(FUFILLMNT_PATH, COUNT_) ORDER BY COUNT_ DESC LIMIT 1)[OFFSET(0)].*
        FROM (
            SELECT
            SKU_STR_ID
            , FUFILLMNT_PATH
            , COUNT(1) COUNT_
            FROM `{staging_project}.{staging_dataset}.RECEIPT_DATA`
            GROUP BY SKU_STR_ID, FUFILLMNT_PATH
            )
        GROUP BY SKU_STR_ID
        ) E
    ON A. SKU_STR_ID = E. SKU_STR_ID

GROUP BY
    CAL_DT
  , SKU_NBR
  , SKU_CRT_DT
  , STR_NBR
  , OH_GRTR_FIVE_PERC_CLSS
  , NEG_OH_POS_SLS_FLG
  , SKU_STR_ID
  , FUFILLMNT_PATH

);