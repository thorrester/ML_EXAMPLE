CREATE OR REPLACE TABLE `{staging_project}.{staging_dataset}.CLR_HIST`
PARTITION BY FSCL_WK_END_DT
AS(
SELECT
*
, DATE_SUB(COALESCE(LEAD(EFF_BGN_WK_DT) OVER(PARTITION BY SKU_STR_ID ORDER BY EFF_BGN_WK_DT), DATE_ADD(CURRENT_DATE, INTERVAL 1 YEAR)),INTERVAL 1 DAY) EFF_END_WK_DT
FROM(
  SELECT
  FSCL_WK_END_DT
  , FSCL_WK_END_DT EFF_BGN_WK_DT
  , CONCAT(CAST(A. SKU_NBR AS STRING),'-', CAST(A. SKU_CRT_DT AS STRING), '-', LPAD(CAST(STR_NBR AS STRING),4,'0')) AS SKU_STR_ID
  , NEW_RETL_AMT
  , MKUP_MKDN_IND
  FROM `{edw_project}.{edw_dataset_mer_price}.STR_PRC_CHG_HIST` A
  INNER JOIN `{edw_project}.{edw_dataset_shared}.FSCL_WK_HIER_FD` C
    ON A. EFF_BGN_DT BETWEEN C. FSCL_WK_BGN_DT AND C. FSCL_WK_END_DT
    AND C. FSCL_WK_END_DT >= DATE_SUB(CURRENT_DATE, INTERVAL 2 YEAR)
  GROUP BY
        FSCL_WK_END_DT
        , EFF_BGN_WK_DT
        , SKU_NBR
        , SKU_CRT_DT
        , STR_NBR
        , NEW_RETL_AMT
        , MKUP_MKDN_IND
  )
);
