CREATE OR REPLACE TABLE `{staging_project}.{staging_dataset}.PACKDOWN_MODEL_DATA_STAGE01_SALES`
PARTITION BY CAL_DT
--CLUSTER BY S
OPTIONS(expiration_timestamp=TIMESTAMP(DATE_ADD(CURRENT_DATE, INTERVAL 2 DAY)))
AS(
-- STAGE 1 INVENTORY

SELECT
 A. CAL_DT
, A. SKU_NBR
, A. SKU_CRT_DT
, A. STR_NBR
, A. SKU_STR_ID
, A. OOS_IND
, A. SHELF_OUT
, A. SHELF_LOW
, A. BINARY_OH_LABEL
, A. MULTI_CLASS_LABEL
, A. LOG_INVENTORY_DOLLARS
, WINDOW_
, DATA_IND

, COALESCE(SUM(CASE WHEN B. SLS_DT = A. CAL_DT THEN GROSS_UNT_SLS ELSE NULL END),0) UNT_SLS
, COALESCE(SUM(CASE WHEN B. SLS_DT = A. CAL_DT THEN GROSS_SLS_AMT ELSE NULL END),0) SLS_AMT

, COALESCE(SUM(CASE WHEN B. SLS_DT = DATE_SUB(A. CAL_DT, INTERVAL 1 DAY) THEN GROSS_UNT_SLS ELSE NULL END),0) PREV_1_DAY_UNTS
, COALESCE(SUM(CASE WHEN B. SLS_DT = DATE_SUB(A. CAL_DT, INTERVAL 2 DAY) THEN GROSS_UNT_SLS ELSE NULL END),0) PREV_2_DAY_UNTS
, COALESCE(SUM(CASE WHEN B. SLS_DT = DATE_SUB(A. CAL_DT, INTERVAL 3 DAY) THEN GROSS_UNT_SLS ELSE NULL END),0) PREV_3_DAY_UNTS
, COALESCE(SUM(CASE WHEN B. SLS_DT = DATE_SUB(A. CAL_DT, INTERVAL 4 DAY) THEN GROSS_UNT_SLS ELSE NULL END),0) PREV_4_DAY_UNTS
, COALESCE(SUM(CASE WHEN B. SLS_DT = DATE_SUB(A. CAL_DT, INTERVAL 5 DAY) THEN GROSS_UNT_SLS ELSE NULL END),0) PREV_5_DAY_UNTS
, COALESCE(SUM(CASE WHEN B. SLS_DT = DATE_SUB(A. CAL_DT, INTERVAL 6 DAY) THEN GROSS_UNT_SLS ELSE NULL END),0) PREV_6_DAY_UNTS

, COALESCE(SUM(CASE WHEN B. SLS_DT = DATE_SUB(A. CAL_DT, INTERVAL 365 DAY) THEN GROSS_UNT_SLS ELSE NULL END),0) PREV_1_DAY_UNTS_LY
, COALESCE(SUM(CASE WHEN B. SLS_DT = DATE_SUB(A. CAL_DT, INTERVAL 366 DAY) THEN GROSS_UNT_SLS ELSE NULL END),0) PREV_2_DAY_UNTS_LY
, COALESCE(SUM(CASE WHEN B. SLS_DT = DATE_SUB(A. CAL_DT, INTERVAL 367 DAY) THEN GROSS_UNT_SLS ELSE NULL END),0) PREV_3_DAY_UNTS_LY
, COALESCE(SUM(CASE WHEN B. SLS_DT = DATE_SUB(A. CAL_DT, INTERVAL 368 DAY) THEN GROSS_UNT_SLS ELSE NULL END),0) PREV_4_DAY_UNTS_LY
, COALESCE(SUM(CASE WHEN B. SLS_DT = DATE_SUB(A. CAL_DT, INTERVAL 369 DAY) THEN GROSS_UNT_SLS ELSE NULL END),0) PREV_5_DAY_UNTS_LY
, COALESCE(SUM(CASE WHEN B. SLS_DT = DATE_SUB(A. CAL_DT, INTERVAL 370 DAY) THEN GROSS_UNT_SLS ELSE NULL END),0) PREV_6_DAY_UNTS_LY

, COALESCE(SUM(CASE WHEN B. SLS_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 6 DAY) AND A. CAL_DT THEN GROSS_UNT_SLS ELSE NULL END),0) PREV_1_WEEK_UNTS
, COALESCE(SUM(CASE WHEN B. SLS_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 13 DAY) AND DATE_SUB(A. CAL_DT, INTERVAL 7 DAY) THEN GROSS_UNT_SLS ELSE NULL END),0) PREV_2_WEEK_UNTS
, COALESCE(SUM(CASE WHEN B. SLS_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 20 DAY) AND DATE_SUB(A. CAL_DT, INTERVAL 14 DAY) THEN GROSS_UNT_SLS ELSE NULL END),0) PREV_3_WEEK_UNTS
, COALESCE(SUM(CASE WHEN B. SLS_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 27 DAY) AND DATE_SUB(A. CAL_DT, INTERVAL 21 DAY) THEN GROSS_UNT_SLS ELSE NULL END),0) PREV_4_WEEK_UNTS
, COALESCE(SUM(CASE WHEN B. SLS_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 34 DAY) AND DATE_SUB(A. CAL_DT, INTERVAL 28 DAY) THEN GROSS_UNT_SLS ELSE NULL END),0) PREV_5_WEEK_UNTS
, COALESCE(SUM(CASE WHEN B. SLS_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 41 DAY) AND DATE_SUB(A. CAL_DT, INTERVAL 35 DAY) THEN GROSS_UNT_SLS ELSE NULL END),0) PREV_6_WEEK_UNTS

, COALESCE(SUM(CASE WHEN B. SLS_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 370 DAY) AND DATE_SUB(A. CAL_DT, INTERVAL 364 DAY) THEN GROSS_UNT_SLS ELSE NULL END),0) PREV_1_WEEK_UNTS_LY
, COALESCE(SUM(CASE WHEN B. SLS_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 377 DAY) AND DATE_SUB(A. CAL_DT, INTERVAL 371 DAY) THEN GROSS_UNT_SLS ELSE NULL END),0) PREV_2_WEEK_UNTS_LY
, COALESCE(SUM(CASE WHEN B. SLS_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 384 DAY) AND DATE_SUB(A. CAL_DT, INTERVAL 378 DAY) THEN GROSS_UNT_SLS ELSE NULL END),0) PREV_3_WEEK_UNTS_LY
, COALESCE(SUM(CASE WHEN B. SLS_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 391 DAY) AND DATE_SUB(A. CAL_DT, INTERVAL 385 DAY) THEN GROSS_UNT_SLS ELSE NULL END),0) PREV_4_WEEK_UNTS_LY
, COALESCE(SUM(CASE WHEN B. SLS_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 398 DAY) AND DATE_SUB(A. CAL_DT, INTERVAL 392 DAY) THEN GROSS_UNT_SLS ELSE NULL END),0) PREV_5_WEEK_UNTS_LY
, COALESCE(SUM(CASE WHEN B. SLS_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 405 DAY) AND DATE_SUB(A. CAL_DT, INTERVAL 399 DAY) THEN GROSS_UNT_SLS ELSE NULL END),0) PREV_6_WEEK_UNTS_LY

, COALESCE(AVG(CASE WHEN B. SLS_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 6 DAY) AND A. CAL_DT THEN GROSS_UNT_SLS ELSE NULL END),0)  R1_WEEK_AVG_UNTS_PER_DAY
, COALESCE(AVG(CASE WHEN B. SLS_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 13 DAY) AND A. CAL_DT THEN GROSS_UNT_SLS ELSE NULL END),0) R2_WEEK_AVG_UNTS_PER_DAY
, COALESCE(AVG(CASE WHEN B. SLS_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 20 DAY) AND A. CAL_DT THEN GROSS_UNT_SLS ELSE NULL END),0) R3_WEEK_AVG_UNTS_PER_DAY
, COALESCE(AVG(CASE WHEN B. SLS_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 27 DAY) AND A. CAL_DT THEN GROSS_UNT_SLS ELSE NULL END),0) R4_WEEK_AVG_UNTS_PER_DAY
, COALESCE(AVG(CASE WHEN B. SLS_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 364 DAY) AND A. CAL_DT THEN GROSS_UNT_SLS ELSE NULL END),0) R12_AVG_UNTS_PER_DAY

, COALESCE(SUM(CASE WHEN B. SLS_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 89 DAY) AND A. CAL_DT THEN GROSS_UNT_SLS ELSE NULL END),0)  R13_UNTS
, COALESCE(SUM(CASE WHEN B. SLS_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 89 DAY) AND A. CAL_DT THEN GROSS_SLS_AMT ELSE NULL END),0)  R13_SLS
, COALESCE(SUM(CASE WHEN B. SLS_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 364 DAY) AND A. CAL_DT THEN GROSS_UNT_SLS + ABS(GROSS_RTN_UNTS) ELSE NULL END),0) R52_UNTS

FROM `{staging_project}.{staging_dataset}.TRAIN_DATA_DATES` A
LEFT JOIN `{staging_project}.{staging_dataset}.SKU_STR_SALES_HIST` B
      ON A. SKU_STR_ID = B. SKU_STR_ID
      AND B. SLS_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 2 YEAR) AND A. CAL_DT

--WHERE A. STR_NBR = '0233'
GROUP BY
        CAL_DT
      , SKU_NBR
      , SKU_CRT_DT
      , STR_NBR
      , SKU_STR_ID
      , OOS_IND
      , SHELF_OUT
      , SHELF_LOW
      , BINARY_OH_LABEL
      , MULTI_CLASS_LABEL
      , LOG_INVENTORY_DOLLARS
      , WINDOW_
      , DATA_IND

);
