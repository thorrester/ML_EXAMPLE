CREATE OR REPLACE TABLE `{staging_project}.{staging_dataset}.PACKDOWN_MODEL_DATA_STAGE01`
PARTITION BY CAL_DT
OPTIONS(expiration_timestamp=TIMESTAMP(DATE_ADD(CURRENT_DATE, INTERVAL 2 DAY)))
AS(
SELECT
  A. CAL_DT
, A. SKU_NBR
, A. SKU_CRT_DT
, A. STR_NBR
, A. SKU_STR_ID
, A. SKU_VLCTY_CD
, A. CURR_RETL_AMT
, A. OOS_IND
, A. SHELF_OUT
, A. SHELF_LOW
, A. BINARY_OH_LABEL
, A. MULTI_CLASS_LABEL
, A. LOG_INVENTORY_DOLLARS
, B. WINDOW_
, A. DATA_IND
, A. MIN_OH_QTY
, A. LEAD_TIME
, A. OH_QTY
, A. PREV_1_DAY_OH
, A. PREV_2_DAY_OH
, A. PREV_3_DAY_OH
, A. PREV_4_DAY_OH
, A. PREV_5_DAY_OH
, A. PREV_6_DAY_OH
, A. OO_QTY
, A. PREV_1_DAY_OO
, A. PREV_2_DAY_OO
, A. PREV_3_DAY_OO
, A. PREV_4_DAY_OO
, A. PREV_5_DAY_OO
, A. PREV_6_DAY_OO
, A. R1_WEEK_AVG_OH_PER_DAY
, A. R2_WEEK_AVG_OH_PER_DAY
, A. R3_WEEK_AVG_OH_PER_DAY
, A. R4_WEEK_AVG_OH_PER_DAY
, A. R13_AVG_OH_PER_DAY
, A. R12_AVG_OH_PER_DAY
, CASE WHEN ROUND(CURR_RETL_AMT,2) <> ROUND(CURR_RETL_AMT_LW,2) THEN 1 ELSE 0 END PC_CHG_LST_WK
, UNT_SLS
, SLS_AMT
, PREV_1_DAY_UNTS
, PREV_2_DAY_UNTS
, PREV_3_DAY_UNTS
, PREV_4_DAY_UNTS
, PREV_5_DAY_UNTS
, PREV_6_DAY_UNTS
, PREV_1_DAY_UNTS_LY
, PREV_2_DAY_UNTS_LY
, PREV_3_DAY_UNTS_LY
, PREV_4_DAY_UNTS_LY
, PREV_5_DAY_UNTS_LY
, PREV_6_DAY_UNTS_LY
, PREV_1_WEEK_UNTS
, PREV_2_WEEK_UNTS
, PREV_3_WEEK_UNTS
, PREV_4_WEEK_UNTS
, PREV_5_WEEK_UNTS
, PREV_6_WEEK_UNTS
, PREV_1_WEEK_UNTS_LY
, PREV_2_WEEK_UNTS_LY
, PREV_3_WEEK_UNTS_LY
, PREV_4_WEEK_UNTS_LY
, PREV_5_WEEK_UNTS_LY
, PREV_6_WEEK_UNTS_LY
, R1_WEEK_AVG_UNTS_PER_DAY
, R2_WEEK_AVG_UNTS_PER_DAY
, R3_WEEK_AVG_UNTS_PER_DAY
, R4_WEEK_AVG_UNTS_PER_DAY
, R12_AVG_UNTS_PER_DAY
, R13_UNTS
, R13_SLS
, R52_UNTS
, COALESCE(SAFE_DIVIDE(PREV_1_WEEK_UNTS, PREV_1_WEEK_UNTS_LY),0) PREV_1_WK_TY_LY_DIFF
, COALESCE(SAFE_DIVIDE(PREV_2_WEEK_UNTS, PREV_2_WEEK_UNTS_LY),0) PREV_2_WK_TY_LY_DIFF
, COALESCE(SAFE_DIVIDE(PREV_3_WEEK_UNTS, PREV_3_WEEK_UNTS_LY),0) PREV_3_WK_TY_LY_DIFF
, COALESCE(SAFE_DIVIDE(PREV_4_WEEK_UNTS, PREV_4_WEEK_UNTS_LY),0) PREV_4_WK_TY_LY_DIFF
, COALESCE(SAFE_DIVIDE(PREV_5_WEEK_UNTS, PREV_5_WEEK_UNTS_LY),0) PREV_5_WK_TY_LY_DIFF
, COALESCE(SAFE_DIVIDE(PREV_6_WEEK_UNTS, PREV_6_WEEK_UNTS_LY),0) PREV_6_WK_TY_LY_DIFF
, COALESCE(SAFE_DIVIDE(R12_AVG_UNTS_PER_DAY, R12_AVG_OH_PER_DAY),-1) R12_AVG_UNTS_OH_RATIO
, COALESCE(SAFE_DIVIDE(R1_WEEK_AVG_UNTS_PER_DAY, R1_WEEK_AVG_OH_PER_DAY),-1) R1_WEEK_AVG_UNTS_OH_RATIO
, COALESCE(SAFE_DIVIDE(R2_WEEK_AVG_UNTS_PER_DAY, R2_WEEK_AVG_OH_PER_DAY),-1) R2_WEEK_AVG_UNTS_OH_RATIO
, COALESCE(SAFE_DIVIDE(R3_WEEK_AVG_UNTS_PER_DAY, R3_WEEK_AVG_OH_PER_DAY),-1) R3_WEEK_AVG_UNTS_OH_RATIO
, COALESCE(SAFE_DIVIDE(R4_WEEK_AVG_UNTS_PER_DAY, R4_WEEK_AVG_OH_PER_DAY),-1) R4_WEEK_AVG_UNTS_OH_RATIO
, OH_QTY + OO_QTY EXP_QTY
, PREV_1_DAY_OH + PREV_1_DAY_OO PREV_1_DAY_EXP_QTY
, PREV_2_DAY_OH + PREV_2_DAY_OO PREV_2_DAY_EXP_QTY
, PREV_3_DAY_OH + PREV_3_DAY_OO PREV_3_DAY_EXP_QTY
, PREV_4_DAY_OH + PREV_4_DAY_OO PREV_4_DAY_EXP_QTY
, PREV_5_DAY_OH + PREV_5_DAY_OO PREV_5_DAY_EXP_QTY
, PREV_6_DAY_OH + PREV_6_DAY_OO PREV_6_DAY_EXP_QTY

, CASE WHEN (PREV_1_DAY_OH - PREV_2_DAY_OH) = ABS(PREV_1_DAY_OO-PREV_2_DAY_OO) THEN 1 ELSE 0 END RCVD_OO
, CASE WHEN COALESCE(PREV_1_DAY_OH,0) = COALESCE(PREV_2_DAY_OH,0) + COALESCE(PREV_2_DAY_OO,0) OR
            (COALESCE(PREV_2_DAY_OH,0) <> COALESCE(PREV_1_DAY_OH,0) AND COALESCE(PREV_1_DAY_OH,0) = COALESCE(PREV_2_DAY_OH,0) + COALESCE(PREV_2_DAY_OO,0) - COALESCE(PREV_1_DAY_OO,0)) OR
            (PREV_1_DAY_UNTS > 0 AND COALESCE(PREV_1_DAY_OH,0) = COALESCE(PREV_2_DAY_OH,0) + COALESCE(PREV_2_DAY_OO,0) - COALESCE(PREV_1_DAY_OO,0) - PREV_1_DAY_UNTS)
            THEN 1 ELSE 0 END AS RECV_QTY_FIXED
, CASE WHEN PREV_1_DAY_UNTS< 0 AND
            (COALESCE(PREV_1_DAY_OH,0) = COALESCE(PREV_2_DAY_OH,0) - PREV_1_DAY_UNTS OR
             COALESCE(PREV_1_DAY_OH,0) = COALESCE(PREV_2_DAY_OH,0) + COALESCE(PREV_2_DAY_OO,0) - PREV_1_DAY_UNTS OR
             COALESCE(PREV_1_DAY_OH,0) = COALESCE(PREV_2_DAY_OH,0) + COALESCE(PREV_2_DAY_OO,0) - COALESCE(PREV_1_DAY_OO,0) - PREV_1_DAY_UNTS)
             THEN 1 ELSE 0 END RETURNED_QTY_FIXED

, DAYS_SINCE_LAST_SALE
, NBR_DAYS_ZERO_SLS
, COALESCE(SAFE_DIVIDE(NBR_DAYS_ZERO_SLS, NBR_DAYS),-1) PCT_DAYS_ZERO_SLS
, COALESCE(POW(SAFE_DIVIDE(NBR_DAYS_ZERO_SLS, NBR_DAYS),DAYS_SINCE_LAST_SALE),-1) AS PCT_CHNC_0_SLS

FROM `{staging_project}.{staging_dataset}.PACKDOWN_MODEL_DATA_STAGE01_INVENTORY` A
INNER JOIN `{staging_project}.{staging_dataset}.PACKDOWN_MODEL_DATA_STAGE01_SALES` B
    ON A. SKU_STR_ID = B. SKU_STR_ID
    AND A. CAL_DT = B. CAL_DT
);