CREATE OR REPLACE TABLE `{staging_project}.{staging_dataset}.PACKDOWN_MODEL_DATA_STAGE02`
PARTITION BY CAL_DT
OPTIONS(expiration_timestamp=TIMESTAMP(DATE_ADD(CURRENT_DATE, INTERVAL 1 DAY)))
AS
(
SELECT
 CAST(C. FSCL_YR AS STRING) FSCL_YR
, SIN(2*ACOS(-1)*(C. FSCL_PRD_NBR/12)) SIN_MTH
, COS(2*ACOS(-1)*(C. FSCL_PRD_NBR/12)) COS_MTH
, SIN(2*ACOS(-1)*(C. FSCL_WK_NBR/52)) SIN_WK
, COS(2*ACOS(-1)*(C. FSCL_WK_NBR/52)) COS_WK
, SIN(2*ACOS(-1)*(C. DAY_OF_MTH_NBR/30)) SIN_DAY
, COS(2*ACOS(-1)*(C. DAY_OF_MTH_NBR/30)) COS_DAY
, A. CAL_DT
, A. SKU_STR_ID
, A. OOS_IND
, A. SHELF_OUT
, A. SHELF_LOW
, A. BINARY_OH_LABEL
, A. MULTI_CLASS_LABEL
, A. LOG_INVENTORY_DOLLARS
, A. SKU_VLCTY_CD
, A. CURR_RETL_AMT
, A. PC_CHG_LST_WK
, A. R12_AVG_UNTS_OH_RATIO
, A. R1_WEEK_AVG_UNTS_OH_RATIO
, A. R2_WEEK_AVG_UNTS_OH_RATIO
, A. R3_WEEK_AVG_UNTS_OH_RATIO
, A. R4_WEEK_AVG_UNTS_OH_RATIO
, A. OH_QTY
, A. PREV_1_DAY_OH
, A. PREV_2_DAY_OH
, A. PREV_3_DAY_OH
, A. PREV_4_DAY_OH
, A. PREV_5_DAY_OH
, A. PREV_6_DAY_OH
, A. OO_QTY
, A. PREV_1_DAY_OO
, A. PREV_2_DAY_OO
, A. PREV_3_DAY_OO
, A. PREV_4_DAY_OO
, A. PREV_5_DAY_OO
, A. PREV_6_DAY_OO
, A. EXP_QTY
, A. PREV_1_DAY_EXP_QTY
, A. PREV_2_DAY_EXP_QTY
, A. PREV_3_DAY_EXP_QTY
, A. PREV_4_DAY_EXP_QTY
, A. PREV_5_DAY_EXP_QTY
, A. PREV_6_DAY_EXP_QTY
#, CASE WHEN PREV_1_DAY_OH >= SAFE_MULTIPLY(D. OH_QTY,.05) THEN 1 ELSE 0 END OH_GRTR_FIVE_PERC_CLSS
#, CASE WHEN A. PREV_1_DAY_OH < 0 AND A. PREV_2_DAY_OH < 0 AND A. PREV_1_DAY_UNTS >0 THEN 1 ELSE 0 END NEG_OH_POS_SLS_FLG
, A. RCVD_OO
, A. RECV_QTY_FIXED
, A. RETURNED_QTY_FIXED
, A. PREV_1_DAY_UNTS_LY
, A. PREV_2_DAY_UNTS_LY
, A. PREV_3_DAY_UNTS_LY
, A. PREV_4_DAY_UNTS_LY
, A. PREV_5_DAY_UNTS_LY
, A. PREV_6_DAY_UNTS_LY
, A. UNT_SLS
, A. PREV_1_DAY_UNTS
, A. PREV_2_DAY_UNTS
, A. PREV_3_DAY_UNTS
, A. PREV_4_DAY_UNTS
, A. PREV_5_DAY_UNTS
, A. PREV_6_DAY_UNTS
, A. PREV_1_WEEK_UNTS
, A. PREV_2_WEEK_UNTS
, A. PREV_3_WEEK_UNTS
, A. PREV_4_WEEK_UNTS
, A. PREV_5_WEEK_UNTS
, A. PREV_6_WEEK_UNTS
, A. PREV_1_WK_TY_LY_DIFF
, A. PREV_2_WK_TY_LY_DIFF
, A. PREV_3_WK_TY_LY_DIFF
, A. PREV_4_WK_TY_LY_DIFF
, A. PREV_5_WK_TY_LY_DIFF
, A. PREV_6_WK_TY_LY_DIFF
, A. R12_AVG_UNTS_PER_DAY
, A. R13_AVG_OH_PER_DAY
, A. R12_AVG_OH_PER_DAY
, A. R13_SLS
, A. R13_UNTS
, A. R52_UNTS
, A. NBR_DAYS_ZERO_SLS
, A. DAYS_SINCE_LAST_SALE
, A. PCT_DAYS_ZERO_SLS
, ROUND(A. PCT_CHNC_0_SLS ,4) PCT_CHNC_ZERO_SLS
, LEAD_TIME
, COALESCE(DATE_DIFF(A. CAL_DT, MAX(F. OH_CHG_DT), WEEK), 52) WKS_SINCE_LAST_OH_CHG

, COALESCE(DATE_DIFF(A.CAL_DT, MAX(B. CAL_DT), DAY),-1) DAYS_SINCE_RCVD_FIN
, COALESCE(COUNT(DISTINCT B. CAL_DT),0)  R12_NBR_ORDRS
, COALESCE(SUM(RCVD_QTY),0) RCVD_QTY_LAST_52_WK
, SUM(CASE WHEN H. RCVD_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 89 DAY) AND A. CAL_DT THEN RCVD_QTY ELSE NULL END) R13_RCVD_QTY
, SUM(CASE WHEN B. CAL_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 89 DAY) AND A. CAL_DT THEN RCVD_COUNT ELSE NULL END) R13_RCVD_QTY_FIN

, SUM(CASE WHEN H. RCVD_DT = A. CAL_DT THEN RCVD_QTY  ELSE 0 END) RCVD_QTY
, SUM(CASE WHEN B. CAL_DT = A. CAL_DT THEN RCVD_COUNT ELSE 0 END) RCVD_QTY_FIN
, SUM(CASE WHEN H. RCVD_DT = DATE_SUB(A. CAL_DT, INTERVAL 1 DAY) THEN RCVD_QTY  ELSE 0 END) RCVD_QTY_PREV_1_DAY
, SUM(CASE WHEN B. CAL_DT  = DATE_SUB(A. CAL_DT, INTERVAL 1 DAY) THEN RCVD_COUNT ELSE 0 END) RCVD_QTY_FIN_PREV_1_DAY

, COALESCE(SUM(CASE WHEN H. RCVD_DT BETWEEN DATE_SUB(A.CAL_DT, INTERVAL 1 WEEK) AND A.CAL_DT THEN RCVD_QTY ELSE 0 END),0) RCVD_QTY_LAST_WK
, COALESCE(COUNT(DISTINCT H. RCVD_DT),0) R12_NBR_ORDRS_RCPT
, COALESCE(COUNT(DISTINCT H. MVNDR_NBR),0) NBR_VNDRS
, COALESCE(DATE_DIFF(A.CAL_DT, MAX(H. RCVD_DT), DAY),-1) DAYS_SINCE_RCVD
, COALESCE(SUM(CASE WHEN H.AUDTD_FLG = 'Y' THEN 1 ELSE 0 END), 0) NBR_AUDTD

, COUNT(DISTINCT CASE WHEN OH_CHG_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 1 WEEK) AND A. CAL_DT THEN OH_CHG_DT ELSE NULL END) OH_CHG_LST_WK
, CASE WHEN SUM(CASE WHEN OH_CHG_DT BETWEEN DATE_SUB(A. CAL_DT,INTERVAL 90 DAY) AND A. CAL_DT THEN 1 ELSE 0 END) >=2 THEN 1 ELSE 0 END OH_CHG_TWICE_90_DAY
, COALESCE(COUNT(DISTINCT OH_CHG_DT), 0) OH_CHGS

, CASE WHEN DATE_DIFF(A. CAL_DT, MAX(F. OH_CHG_DT), DAY) <= 2 AND COALESCE(COALESCE(DATE_DIFF(A.CAL_DT, MAX(H. RCVD_DT), DAY),-1), COALESCE(DATE_DIFF(A.CAL_DT, MAX(B. CAL_DT), DAY),-1)) <= 2 THEN 1 ELSE 0 END OH_CHG_WTHN_2_DAY_RECPT

, CASE WHEN COUNT(DISTINCT CASE WHEN OH_CHG_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 2 WEEK) AND A. CAL_DT THEN OH_CHG_DT ELSE NULL END) >= 1 AND COALESCE(DATE_DIFF(A.CAL_DT, MAX(H. RCVD_DT), DAY),-1)BETWEEN 0 AND 14 THEN 1 ELSE 0 END SHRINK_FLG
, CASE WHEN SUM(CASE WHEN OH_CHG_DT BETWEEN DATE_SUB(A. CAL_DT,INTERVAL 7 DAY) AND DATE_SUB(A. CAL_DT,INTERVAL 1 DAY) THEN 1 ELSE 0 END) > 0 THEN 1 ELSE 0 END OH_CHG_PREV_WK_FLG

FROM `{staging_project}.{staging_dataset}.PACKDOWN_MODEL_DATA_STAGE01` A
LEFT JOIN `{staging_project}.{staging_dataset}.STR_SHIPMENT_DATA` B
  ON B. CAL_DT BETWEEN DATE_SUB(A. CAL_DT , INTERVAL 52 WEEK) AND A. CAL_DT
  AND A. SKU_STR_ID = B. SKU_STR_ID

INNER JOIN `{edw_project}.{edw_dataset_shared}.CAL_PRD_HIER_FD` C
  ON A. CAL_DT = C. CAL_DT

LEFT JOIN `{staging_project}.{staging_dataset}.RECEIPT_DATA` H
  ON H. RCVD_DT BETWEEN DATE_SUB(A. CAL_DT , INTERVAL 52 WEEK) AND A. CAL_DT
  AND A. SKU_STR_ID = H. SKU_STR_ID

LEFT JOIN `{staging_project}.{staging_dataset}.OH_CHGS` F
    ON F. OH_CHG_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 52 WEEK) AND A. CAL_DT
    AND A. SKU_STR_ID = F. SKU_STR_ID

GROUP BY

      FSCL_YR
    , SIN_MTH
    , COS_MTH
    , SIN_WK
    , COS_WK
    , SIN_DAY
    , COS_DAY
    , CAL_DT
    , SKU_STR_ID
    , OOS_IND
    , SHELF_OUT
    , SHELF_LOW
    , BINARY_OH_LABEL
    , MULTI_CLASS_LABEL
    , LOG_INVENTORY_DOLLARS
    , SKU_VLCTY_CD
    , CURR_RETL_AMT
    , PC_CHG_LST_WK
    , R12_AVG_UNTS_OH_RATIO
    , R1_WEEK_AVG_UNTS_OH_RATIO
    , R2_WEEK_AVG_UNTS_OH_RATIO
    , R3_WEEK_AVG_UNTS_OH_RATIO
    , R4_WEEK_AVG_UNTS_OH_RATIO
    , OH_QTY
    , PREV_1_DAY_OH
    , PREV_2_DAY_OH
    , PREV_3_DAY_OH
    , PREV_4_DAY_OH
    , PREV_5_DAY_OH
    , PREV_6_DAY_OH
    , OO_QTY
    , PREV_1_DAY_OO
    , PREV_2_DAY_OO
    , PREV_3_DAY_OO
    , PREV_4_DAY_OO
    , PREV_5_DAY_OO
    , PREV_6_DAY_OO
    , EXP_QTY
    , PREV_1_DAY_EXP_QTY
    , PREV_2_DAY_EXP_QTY
    , PREV_3_DAY_EXP_QTY
    , PREV_4_DAY_EXP_QTY
    , PREV_5_DAY_EXP_QTY
    , PREV_6_DAY_EXP_QTY
    , RCVD_OO
    , RECV_QTY_FIXED
    , RETURNED_QTY_FIXED
    , PREV_1_DAY_UNTS_LY
    , PREV_2_DAY_UNTS_LY
    , PREV_3_DAY_UNTS_LY
    , PREV_4_DAY_UNTS_LY
    , PREV_5_DAY_UNTS_LY
    , PREV_6_DAY_UNTS_LY
    , UNT_SLS
    , PREV_1_DAY_UNTS
    , PREV_2_DAY_UNTS
    , PREV_3_DAY_UNTS
    , PREV_4_DAY_UNTS
    , PREV_5_DAY_UNTS
    , PREV_6_DAY_UNTS
    , PREV_1_WEEK_UNTS
    , PREV_2_WEEK_UNTS
    , PREV_3_WEEK_UNTS
    , PREV_4_WEEK_UNTS
    , PREV_5_WEEK_UNTS
    , PREV_6_WEEK_UNTS
    , PREV_1_WK_TY_LY_DIFF
    , PREV_2_WK_TY_LY_DIFF
    , PREV_3_WK_TY_LY_DIFF
    , PREV_4_WK_TY_LY_DIFF
    , PREV_5_WK_TY_LY_DIFF
    , PREV_6_WK_TY_LY_DIFF
    , R12_AVG_UNTS_PER_DAY
    , R12_AVG_OH_PER_DAY
    , R13_AVG_OH_PER_DAY
    , R13_SLS
    , R13_UNTS
    , R52_UNTS
    , NBR_DAYS_ZERO_SLS
    , DAYS_SINCE_LAST_SALE
    , PCT_DAYS_ZERO_SLS
    , PCT_CHNC_ZERO_SLS
    , LEAD_TIME

);