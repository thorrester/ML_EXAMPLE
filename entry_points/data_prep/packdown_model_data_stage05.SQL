CREATE OR REPLACE TABLE `{staging_project}.{staging_dataset}.PACKDOWN_MODEL_DATA_STAGE05`
PARTITION BY CAL_DT
OPTIONS(expiration_timestamp=TIMESTAMP(DATE_ADD(CURRENT_DATE, INTERVAL 1 DAY)))
AS(
SELECT
  A. CAL_DT
, A. SKU_STR_ID
, A. WINDOW_
, A. DATA_IND
, CASE WHEN SUM(CASE WHEN MKUP_MKDN_IND IS NOT NULL THEN 1 ELSE 0 END) >= 1 THEN 1 ELSE 0 END CLR_FLG
, COALESCE(SAFE_DIVIDE(SUM(ABS(SHNK_DLRS)),SUM(SLS_DLRS)),-1) as SHNK_PCT
, COALESCE(SUM(emp_pkg_unt_qty),0) EMPTY_PKG_90_DAY_QTY
FROM `{staging_project}.{staging_dataset}.PACKDOWN_MODEL_DATA_STAGE01` A

LEFT JOIN `{staging_project}.{staging_dataset}.SHRINK_PCT` B
  ON B. FSCL_WK_END_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 52 WEEK) AND A. CAL_DT
  AND A. SKU_STR_ID = B. SKU_STR_ID

LEFT JOIN `{staging_project}.{staging_dataset}.EMPTY_PKGS` C
    ON C. FSCL_WK_END_DT BETWEEN DATE_SUB(A. CAL_DT, INTERVAL 90 DAY) AND A. CAL_DT
    AND A. SKU_STR_ID = C. SKU_STR_ID

LEFT JOIN `{staging_project}.{staging_dataset}.CLR_HIST` D
  ON A. CAL_DT BETWEEN D. EFF_BGN_WK_DT AND D. EFF_END_WK_DT
  AND A. SKU_STR_ID = D. SKU_STR_ID

GROUP BY
      CAL_DT
    , SKU_STR_ID
    , WINDOW_
    , DATA_IND
);